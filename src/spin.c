/*
 * Copyright (C) 2025, Wen-Xuan Zhang <serialcore@outlook.com>
 * Copyright (C) 2025, Si-Qiang Luo <luosq15@lzu.edu.cn>
 *
 * SPDX-License-Identifier: GPL-3.0-or-later
 */

#include <spin.h>

#include <math.h>
#include <stdlib.h>

/* precomputed mantissas for (d/2)! indexed by d */
static double mantissa[256] = {
	1.00000000000000000, 8.86226925452758013, 1.00000000000000000, 1.32934038817913702,
    2.00000000000000000, 3.32335097044784255, 6.00000000000000000, 1.16317283965674489,
    2.40000000000000000, 5.23427777845535201, 1.20000000000000000, 2.87885277815044361,
    7.20000000000000000, 1.87125430579778834, 5.04000000000000000, 1.40344072934834126,
    4.03200000000000000, 1.19292461994609007, 3.62880000000000000, 1.13327838894878556,
    3.62880000000000000, 1.18994230839622484, 3.99168000000000000, 1.36843365465565857,
    4.79001600000000000, 1.71054206831957321, 6.22702080000000000, 2.30923179223142384,
    8.71782912000000000, 3.34838609873556457, 1.30767436800000000, 5.18999845304012508,
    2.09227898880000000, 8.56349744751620638, 3.55687428096000000, 1.49861205331533611,
    6.40237370572800000, 2.77243229863337181, 1.21645100408832000, 5.40624298233507504,
	2.43290200817664000, 1.10827981137869038, 5.10909421717094400, 2.38280159446418432,
    1.12400072777760768, 5.36130358754441473, 2.58520167388849766, 1.25990634307293746,
    6.20448401733239439, 3.08677054052869678, 1.55112100433309859, 7.87126487834817679,
    4.03291461126605635, 2.08588519276226685, 1.08888694504183521, 5.73618428009623384,
    3.04888344611713860, 1.63481251982742664, 8.84176199373970195, 4.82269693349090860,
    2.65252859812191058, 1.47092256471472712, 8.22283865417792281, 4.63340607885139043,
    2.63130836933693530, 1.50585697562670189, 8.68331761881188649, 5.04462086834945134,
    2.95232799039604140, 1.74039419958056071, 1.03331479663861449, 6.17839940851099052,
    3.71993326789901217, 2.25511578410651154, 1.37637530912263450, 8.45668419039941828,
    5.23022617466601111, 3.25582341330377604, 2.03978820811974433, 1.28605024825499153,
    8.15915283247897734, 5.20850350543271572, 3.34525266131638071, 2.16152895475457702,
    1.40500611775287989, 9.18649805770695235, 6.04152630633738356, 3.99612665510252427,
    2.65827157478844876, 1.77827636152062330, 1.19622220865480194, 8.09115744491883602,
    5.50262215981208895, 3.76238821188725875, 2.58623241511168180, 1.78713440064644790,
    1.24139155925360726, 8.66760184313527234, 6.08281864034267560, 4.29046291235195981,
    3.04140932017133780, 2.16668377073773970, 1.55111875328738228, 1.11584214192993594,
    8.06581751709438785, 5.85817124513216372, 4.27488328406002556, 3.13412161614570759,
    2.30843697339241380, 1.70809628079941063, 1.26964033536582759, 9.47993435843672904,
    7.10998587804863451, 5.35616291251675191, 4.05269195048772167, 3.07979367469713234,
    2.35056133128287857, 1.80167929969782242, 1.38683118545689835, 1.07199918332020434,
    8.32098711274139014, 6.48559505908723626, 5.07580213877224798, 3.98864096133865030,
    3.14699732603879375, 2.49290060083665644, 1.98260831540444006, 1.58299188153127684,
    1.26886932185884164, 1.02102976358767356, 8.24765059208247066, 6.68774495149926183,
    5.44344939077443064, 4.44735039274700911, 3.64711109181886852, 3.00196151510423115,
    2.48003554243683059, 2.05634363784639834, 1.71122452428141311, 1.42915882830324684,
	1.19785716699698917, 1.00755697395378902, 8.50478588567862317, 7.20403236376959154,
    6.12344583768860868, 5.22292346373295386, 4.47011546151268434, 3.83884874584372109,
    3.30788544151938641, 2.85994231565357221, 2.48091408113953980, 2.15925644831844702,
    1.88549470166605025, 1.65183118296361197, 1.45183092028285869, 1.28016916679679927,
    1.13242811782062978, 1.00493279593548743, 8.94618213078297528, 7.98921572768712509,
    7.15694570462638022, 6.43131866078813570, 5.79712602074736798, 5.24152470854233059,
    4.75364333701284174, 4.32425788454742274, 3.94552396972065865, 3.61075533359709798,
    3.31424013456535326, 3.05108825688954780, 2.81710411438055027, 2.60868045964056337,
    2.42270953836727323, 2.25650859758908731, 2.10775729837952771, 1.97444502289045140,
    1.85482642257398439, 1.74738384525804948, 1.65079551609084610, 1.56390854150595429,
	1.48571596448176149, 1.41533723006288863, 1.35200152767840296, 1.29503356550754310,
    1.24384140546413072, 1.19790604809447736, 1.15677250708164157, 1.12004215496833633,
    1.08736615665674308, 1.05843983644507784, 1.03299784882390592, 1.01081004380504933,
    9.91677934870949689, 9.75431692271872611, 9.61927596824821198, 9.51045899965075796,
    9.42689044888324774, 9.36780211465599659, 9.33262154439441526, 9.32096310408271660,
    9.33262154439441526, 9.36756791960313019, 9.42594775983835942, 9.50808143839717714,
    9.61446671503512660, 9.74578347435710657, 9.90290071648618040, 1.00868858959596053,
    1.02990167451456276, 1.05407957612777875, 1.08139675824029090, 1.11205395281480658,
    1.14628056373470835, 1.18433745974776901, 1.22652020319613793, 1.27316276922885168,
    1.32464181945182897, 1.38138160461330408, 1.44385958320249358, 1.51261285705156797,
    1.58824554152274294, 1.67143720704198260, 1.76295255109024466, 1.86365248585181060,
    1.97450685722107402, 2.09660904658328693, 2.23119274865981364, 2.37965126787203067,
    2.54355973347218755, 2.72470070171347511, 2.92509369349301569, 3.14702931047906376,
    3.39310868445189820, 3.66628914670810928, 3.96993716080872089, 4.30788974738202840,
    4.68452584975429065, 5.10484935064770366, 5.57458576120760588, 6.10029497402400587,
    6.68950291344912705, 7.35085544369892707, 8.09429852527344374, 8.93128936409419640,
    9.87504420083360136, 1.09408294710153905, 1.21463043670253296, 1.35119243967040073,
    1.50614174151114087, 1.68223458738964891, 1.88267717688892609, 2.11120440717400939,
    2.37217324288004688, 2.67067357507512188, 3.01266001845765954, 3.40510880822078040
};

/* precomputed exponents for (d/2)! indexed by d */
static int exponent[256] = {
	  0,  -1,   0,   0,   0,   0,   0,   1,   1,   1,   2,   2,   2,   3,   3,   4,
      4,   5,   5,   6,   6,   7,   7,   8,   8,   9,   9,  10,  10,  11,  12,  12,
     13,  13,  14,  15,  15,  16,  17,  17,  18,  19,  19,  20,  21,  21,  22,  23,
     23,  24,  25,  25,  26,  27,  28,  28,  29,  30,  30,  31,  32,  33,  33,  34,
     35,  36,  36,  37,  38,  39,  40,  40,  41,  42,  43,  43,  44,  45,  46,  47,
	 47,  48,  49,  50,  51,  51,  52,  53,  54,  55,  56,  56,  57,  58,  59,  60,
     61,  61,  62,  63,  64,  65,  66,  67,  67,  68,  69,  70,  71,  72,  73,  73,
     74,  75,  76,  77,  78,  79,  80,  81,  81,  82,  83,  84,  85,  86,  87,  88,
     89,  90,  90,  91,  92,  93,  94,  95,  96,  97,  98,  99, 100, 101, 101, 102,
    103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 116, 117,
    118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133,
    134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149,
    149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 165,
    166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181,
    182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197,
	198, 199, 200, 201, 202, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214
};

/* precomputed mantissas for 1/(d/2)! indexed by d */
static double mantissa_inverse[256] = {
	1.00000000000000000, 1.12837916709551257, 1.00000000000000000, 7.52252778063675049,
    5.00000000000000000, 3.00901111225470019, 1.66666666666666666, 8.59717460644200056,
    4.16666666666666666, 1.91048324587600012, 8.33333333333333333, 3.47360590159272750,
    1.38888888888888888, 5.34400907937342692, 1.98412698412698412, 7.12534543916456923,
    2.48015873015873015, 8.38275934019361086, 2.75573192239858906, 8.82395720020380090,
	2.75573192239858906, 8.40376876209885800, 2.50521083854417187, 7.30762501052074609,
    2.08767569878680989, 5.84610000841659687, 1.60590438368216146, 4.33044445067896064,
    1.14707455977297247, 2.98651341426135217, 7.64716373181981647, 1.92678284791054978,
    4.77947733238738529, 1.16774718055184835, 2.81145725434552076, 6.67284103172484774,
    1.56192069685862264, 3.60694109822964743, 8.22063524662432971, 1.84971338370751150,
    4.11031762331216485, 9.02299211564639757, 1.95729410633912612, 4.19674051890530119,
    8.89679139245057328, 1.86521800840235608, 3.86817017063068403, 7.93709790809513229,
    1.61173757109611834, 3.23963179922250297, 6.44695028438447339, 1.27044384283235410,
    2.47959626322479746, 4.79412770880133625, 9.18368986379554614, 1.74331916683684954,
    3.27988923706983791, 6.11690935732227911, 1.13099628864477169, 2.07352859570246749,
	3.76998762881590564, 6.79845441213923769, 1.21612504155351794, 2.15823949591721831,
    3.80039075485474359, 6.64073691051451789, 1.15163356207719502, 1.98230952552672175,
    3.38715753552116184, 5.74582471167165727, 9.67759295863189099, 1.61854217230187528,
    2.68822026628663638, 4.43436211589554873, 7.26546017915307131, 1.18249656423881299,
    1.91196320504028192, 3.07141964737354025, 4.90246975651354339, 7.77574594271782341,
	1.22561743912838584, 1.91993726980686997, 2.98931082714240451, 4.62635486700450597,
    7.11740673129143931, 1.08855408635400140, 1.65521086774219518, 2.50242318702069288,
    3.76184288123226179, 5.62342289218133233, 8.35965084718280398, 1.23591711916073238,
    1.81731540156147912, 2.65788627776501587, 3.86662851396059388, 5.59555005845266499,
    8.05547607075123726, 1.15372166153663195, 1.64397470831657903, 2.33075083138713526,
	3.28794941663315806, 4.61534818096462429, 6.44695964045717268, 8.96184112808664911,
    1.23979993085714859, 1.70701735773079030, 2.33924515256065772, 3.19068664996409403,
    4.33193546770492170, 5.85447091736531014, 7.87624630491803946, 1.05485962475050633,
    1.40647255444964990, 1.86700818539912625, 2.46749570956078930, 3.24697075721587174,
    4.25430294751860225, 5.55037736276217392, 7.21068296189593602, 9.32836531556667886,
	1.20178049364932267, 1.54187856455647584, 1.97013195680216831, 2.50711961716500137,
    3.17763218839059405, 4.01139138746400219, 5.04386061649300643, 6.31715179128189322,
    7.88103221327032254, 9.79403378493316779, 1.21246649434928039, 1.49527233357758286,
    1.83707044598375816, 2.24852982492869604, 2.74189618803545995, 3.33115529619066080,
    4.03220027652273522, 4.86300043239512526, 5.84376851669961627, 6.99712292430953275,
	8.34824073814230896, 9.92499705575820248, 1.17580855466793083, 1.38811147632981852,
    1.63306743703879283, 1.91463651907561176, 2.23707868087505867, 2.60494764500083233,
    3.02307929847980902, 3.49657402013534541, 4.03077239797307869, 4.63122386772893432,
    5.30364789206984038, 6.05388740879599257, 6.88785440528550699, 7.81146762425289365,
    8.83058257087885512, 9.95091417102279445, 1.11779526213656393, 1.25168731710978546,
    1.39724407767070492, 1.55489107715501300, 1.72499268848235175, 1.90784181246013865,
    2.10364962010042897, 2.31253553025471351, 2.53451761457883008, 2.76950362904756109,
    3.01728287449860724, 3.27751908763024982, 3.54974455823365558, 3.83335565804707581,
    4.12760995143448324, 4.43162503820471192, 4.74437925452239452, 5.06471432937681362,
    5.39134006195726651, 5.72284105014329223, 6.05768546287333315, 6.39423581021596897,
	6.73076162541481461, 7.06545393394029721, 7.39644134660968639, 7.72180757807682755,
    8.03961015935835477, 8.34790008440738114, 8.64474210683694062, 8.92823538439292100,
    9.19653415620951129, 9.44786813163272064, 9.68056226969422241, 9.89305563521750852,
    1.00839190309314816, 1.02518711245777290, 1.03957928153932800, 1.05147396149515169,
    1.06079518524421225, 1.06748625532502710, 1.07151028812546692, 1.07285050786434884,
	1.07151028812546692, 1.06751294314860581, 1.06090127537174942, 1.05173688980158208,
    1.04009928958014649, 1.02608477053812886, 1.00980513551470533, 9.91386251727660739,
    9.70966476456447441, 9.48694977729818889, 9.24729977577568991, 8.99236945715468141,
    8.72386771299593388, 8.44353939638937222, 8.15314739532330269, 7.85445525245522997,
    7.54921055122528027, 7.23912926493569583, 6.92588123965622043, 6.61107695427917427,
    6.29625567241474584, 5.98287507174585907, 5.67230240758085211, 5.36580723923395432,
    5.06455572105433224, 4.76960643487462606, 4.48190771774719667, 4.20229641839174102,
    3.93149799802385673, 3.67012787632466465, 3.41869391132509281, 3.17759989292178757,
    2.94714992355611449, 2.72755355615604083, 2.51893155859496965, 2.32132217545194965,
    2.13468776152116072, 1.95892166704805877, 1.79385526178248800, 1.63926499334565588,
    1.49487938481874000, 1.36038588659390529, 1.23543750811466115, 1.11965916592090970,
    1.01265369517595176, 9.14007482384416087, 8.23295687134920137, 7.40087030270782257,
    6.63948134786225917, 5.94447413872114263, 5.31158507828980734, 4.73663277985748416,
    4.21554371292841852, 3.74437373901777404, 3.31932575821135316, 2.93676371687668552
};

/* precomputed exponents for 1/(d/2)! indexed by d */
static int exponent_inverse[256] = {
	   0,    0,    0,   -1,   -1,   -1,   -1,   -2,   -2,   -2,   -3,   -3,   -3,   -4,   -4,   -5,
      -5,   -6,   -6,   -7,   -7,   -8,   -8,   -9,   -9,  -10,  -10,  -11,  -11,  -12,  -13,  -13,
     -14,  -14,  -15,  -16,  -16,  -17,  -18,  -18,  -19,  -20,  -20,  -21,  -22,  -22,  -23,  -24,
     -24,  -25,  -26,  -26,  -27,  -28,  -29,  -29,  -30,  -31,  -31,  -32,  -33,  -34,  -34,  -35,
     -36,  -37,  -37,  -38,  -39,  -40,  -41,  -41,  -42,  -43,  -44,  -44,  -45,  -46,  -47,  -48,
	 -48,  -49,  -50,  -51,  -52,  -52,  -53,  -54,  -55,  -56,  -57,  -57,  -58,  -59,  -60,  -61,
     -62,  -62,  -63,  -64,  -65,  -66,  -67,  -68,  -68,  -69,  -70,  -71,  -72,  -73,  -74,  -74,
     -75,  -76,  -77,  -78,  -79,  -80,  -81,  -82,  -82,  -83,  -84,  -85,  -86,  -87,  -88,  -89,
     -90,  -91,  -91,  -92,  -93,  -94,  -95,  -96,  -97,  -98,  -99, -100, -101, -102, -102, -103,
    -104, -105, -106, -107, -108, -109, -110, -111, -112, -113, -114, -115, -116, -117, -117, -118,
	-119, -120, -121, -122, -123, -124, -125, -126, -127, -128, -129, -130, -131, -132, -133, -134,
    -135, -136, -137, -138, -139, -140, -141, -142, -143, -144, -145, -146, -147, -148, -149, -150,
    -150, -151, -152, -153, -154, -155, -156, -157, -158, -159, -160, -161, -162, -163, -164, -166,
    -167, -168, -169, -170, -171, -172, -173, -174, -175, -176, -177, -178, -179, -180, -181, -182,
    -183, -184, -185, -186, -187, -188, -189, -190, -191, -192, -193, -194, -195, -196, -197, -198,
    -199, -200, -201, -202, -203, -205, -206, -207, -208, -209, -210, -211, -212, -213, -214, -215
};

/* scale the input by 2 to index precomputed arrays */
static inline double factman(double x);
static inline double factman(double x)
{
    return mantissa[(int)(2*x)];
}

/* scale the input by 2 to index precomputed arrays */
static inline int factexp(double x);
static inline int factexp(double x)
{
    return exponent[(int)(2*x)];
}

/* scale the input by 2 to index precomputed arrays */
static inline double factman_inverse(double x);
static inline double factman_inverse(double x)
{
    return mantissa_inverse[(int)(2*x)];
}

/* scale the input by 2 to index precomputed arrays */
static inline int factexp_inverse(double x);
static inline int factexp_inverse(double x)
{
    return exponent_inverse[(int)(2*x)];
}

double clebsch_gordan(double j1, double m1, double j2, double m2, double j, double m)
{
	int x, xmin, xmax;
    double manfactor, mansum, factor, sum;
    int expfactor, expsum;
	
    /* constrain the inputs by mathematical conditions */
	if (j1 < 0 || j2 < 0 || j < 0)
        return 0;
	if (j1+j2 < j || abs(j1-j2) > j || (int)(2*(j1+j2+j))%2 != 0)
        return 0;
	if (abs(m1) > j1 || abs(m2) > j2 || abs(m) > j || (int)(2*(j1+m1))%2 != 0 || (int)(2*(j2+m2))%2 != 0 || (int)(2*(j+m))%2 != 0)
        return 0;
	if (m1+m2 != m)
        return 0;

    /* use scientific notation to compute factorials and the factor */
	manfactor = factman(j1+j2-j) * factman(j1-j2+j) * factman(-j1+j2+j) 
        * factman(j1+m1) * factman(j1-m1) * factman(j2+m2) * factman(j2-m2) 
        * factman(j+m) * factman(j-m) * factman_inverse(j1+j2+j+1);
	expfactor = factexp(j1+j2-j) + factexp(j1-j2+j) + factexp(-j1+j2+j) 
        + factexp(j1+m1) + factexp(j1-m1) + factexp(j2+m2) + factexp(j2-m2)
        + factexp(j+m) + factexp(j-m) + factexp_inverse(j1+j2+j+1);
	factor = sqrt((2*j+1)*manfactor*pow(10, expfactor));
	
    xmin = -j+j2-m1 > 0 ? -j+j2-m1 : 0;
    xmin = -j+j1+m2 > xmin ? -j+j1+m2 : xmin;
    xmax = j1-m1 < j1+j2-j ? j1-m1 : j1+j2-j;
    xmax = j2+m2 < xmax ? j2+m2 : xmax;
    if (xmax-xmin <= -1)
        return 0;
    
    /* compute sums */
    sum = 0;
    for (x = xmin; x <= xmax; x += 1) {
        mansum = factman_inverse(x) * factman_inverse(j1+j2-j-x) * factman_inverse(j1-m1-x) * factman_inverse(j2+m2-x) 
            * factman_inverse(j-j2+m1+x) * factman_inverse(j-j1-m2+x);
		if (x%2 != 0)
			mansum = -mansum;
		expsum = factexp_inverse(x) + factexp_inverse(j1+j2-j-x) + factexp_inverse(j1-m1-x) + factexp_inverse(j2+m2-x) 
            + factexp_inverse(j-j2+m1+x) + factexp_inverse(j-j1-m2+x);
		sum += mansum*pow(10, expsum);
	}

	return factor * sum;
}

double threeJ_symbol(double j1, double m1, double j2, double m2, double j, double m)
{
	return pow(-1, j1-j2-m) / sqrt(2*j+1) * clebsch_gordan(j1, m1, j2, m2, j, -m);
}

double sixJ_symbol(double j1, double j2, double j12, double j3, double j, double j23)
{
	int x, xmin, xmax;
    double manfactor, mansum, factor, sum;
    int expfactor, expsum;
	
    /* constrain the inputs by mathematical conditions */
	if (j1 < 0 || j2 < 0 || j12 < 0 || j3 < 0 || j < 0 || j23 < 0)
        return 0;
	if (j1+j2 < j12 || abs(j1-j2) > j12 || (int)(2*(j1+j2+j12))%2 != 0)
        return 0;
    if (j2+j3 < j23 || abs(j2-j3) > j23 || (int)(2*(j2+j3+j23))%2 != 0)
        return 0;
    if (j12+j3 < j || abs(j12-j3) > j || (int)(2*(j12+j3+j))%2 != 0)
        return 0;
    if (j1+j23 < j || abs(j1-j23) > j || (int)(2*(j1+j23+j))%2 != 0)
        return 0;

    /* use scientific notation to compute factorials and the factor */
	manfactor = factman(j1+j2-j12) * factman(j1-j2+j12) * factman(-j1+j2+j12) * factman_inverse(j1+j2+j12+1)
        * factman(j2+j3-j23) * factman(j2-j3+j23) * factman(-j2+j3+j23) * factman_inverse(j2+j3+j23+1)
        * factman(j12+j3-j) * factman(j12-j3+j) * factman(-j12+j3+j) * factman_inverse(j12+j3+j+1)
        * factman(j1+j23-j) * factman(j1-j23+j) * factman(-j1+j23+j) * factman_inverse(j1+j23+j+1);
	expfactor = factexp(j1+j2-j12) + factexp(j1-j2+j12) + factexp(-j1+j2+j12) + factexp_inverse(j1+j2+j12+1)
        + factexp(j2+j3-j23) + factexp(j2-j3+j23) + factexp(-j2+j3+j23) + factexp_inverse(j2+j3+j23+1)
        + factexp(j12+j3-j) + factexp(j12-j3+j) + factexp(-j12+j3+j) + factexp_inverse(j12+j3+j+1)
        + factexp(j1+j23-j) + factexp(j1-j23+j) + factexp(-j1+j23+j) + factexp_inverse(j1+j23+j+1);
	factor = sqrt(manfactor*pow(10, expfactor));

    xmin = j12+j3+j > j1+j2+j12 ? j12+j3+j : j1+j2+j12;
    xmin = j1+j23+j > xmin ? j1+j23+j : xmin;
    xmin = j2+j3+j23 > xmin ? j2+j3+j23 : xmin;
    xmax = j1+j12+j3+j23 < j1+j2+j3+j ? j1+j12+j3+j23 : j1+j2+j3+j;
    xmax = j2+j12+j+j23 < xmax ? j2+j12+j+j23 : xmax;
	
    /* compute sums */
	sum = 0;
	for (x = xmin; x <= xmax; x += 1) {
        mansum = factman(x+1) * factman_inverse(x-j1-j2-j12) * factman_inverse(x-j12-j3-j) * factman_inverse(x-j1-j23-j) 
            * factman_inverse(x-j2-j3-j23) * factman_inverse(j1+j2+j3+j-x) * factman_inverse(j1+j12+j3+j23-x) * factman_inverse(j2+j12+j+j23-x);
		if (x%2 != 0)
			mansum = -mansum;   
		expsum = factexp(x+1) + factexp_inverse(x-j1-j2-j12) + factexp_inverse(x-j12-j3-j) + factexp_inverse(x-j1-j23-j) 
            + factexp_inverse(x-j2-j3-j23) + factexp_inverse(j1+j2+j3+j-x) + factexp_inverse(j1+j12+j3+j23-x) + factexp_inverse(j2+j12+j+j23-x);
		sum += mansum*pow(10, expsum);
	}
	
	return factor * sum;
}

double nineJ_symbol(double j1, double j2, double j12, double j3, double j4, double j34, double j13, double j24, double j)
{
	int x, xmin, xmax;
	double sum;

    /* constrain the inputs by mathematical conditions */
	if (j1 < 0 || j2 < 0 || j12 < 0 || j3 < 0 || j4 < 0 || j34 < 0 || j13 < 0 || j24 < 0 || j < 0)
        return 0;
	if (j1+j2 < j12 || abs(j1-j2) > j12 || (int)(2*(j1+j2+j12))%2 != 0)
        return 0;
	if (j3+j4 < j34 || abs(j3-j4) > j34 || (int)(2*(j3+j4+j34))%2 != 0)
        return 0;
	if (j1+j3 < j13 || abs(j1-j3) > j13 || (int)(2*(j1+j3+j13))%2 != 0)
        return 0;
	if (j2+j4 < j24 || abs(j2-j4) > j24 || (int)(2*(j2+j4+j24))%2 != 0)
        return 0;
	if (j12+j34 < j || abs(j12-j34) > j || (int)(2*(j12+j34+j))%2 != 0)
        return 0;
	if (j13+j24 < j || abs(j13-j24) > j || (int)(2*(j13+j24+j))%2 != 0)
        return 0;

	xmin = abs((int)(j2-j34)) > abs((int)(j3-j24)) ? abs((int)(2*(j2-j34))) : abs((int)(2*(j3-j24)));
	xmax = abs((int)(j2+j34)) < abs((int)(j3+j24)) ? abs((int)(2*(j2+j34))) : abs((int)(2*(j3+j24)));

    /* compute sums */
	sum = 0;
	for (x = xmin; x <= xmax; x += 1) {
		sum += pow(-1, x) * (x+1) 
            * sixJ_symbol(j1, j2, j12, j34, j, 0.5*x)
            * sixJ_symbol(j3, j4, j34, j2, 0.5*x, j24)
            * sixJ_symbol(j13, j24, j, 0.5*x, j1, j3);
	}

	return sum;
}

double kronecker_delta(double *i, double *j, int n)
{
    for (int k = 0; k < n; k++) {
        if (i[k] != j[k]) {
            return 0;
        }
    }
    return 1;
}

double sh_sdots(double s1, double s2, double s, double l, double s1p, double s2p, double sp, double lp)
{
    double a[] = {s1, s2, s, l};
    double b[] = {s1p, s2p, sp, lp};

    return 0.5 * (s*(s+1)-s1*(s1+1)-s2*(s2+1)) * kronecker_delta(a, b, 4);
}

double sh_ldots1(double s1, double s2, double s, double l, double s1p, double s2p, double sp, double lp, double j)
{
    double a[] = {s1, s2, l};
    double b[] = {s1p, s2p, lp};

    return pow(-1, s+lp+j) * sixJ_symbol(sp, s, 1, l, lp, j) * pow(-1, s1p+s2p+s+1) * sqrt((2*sp+1)*(2*s+1)) * sixJ_symbol(s1, s1p, 1, sp, s, s2p) 
        * sqrt((2*s1+1)*(s1+1)*s1) * sqrt((2*l+1)*(l+1)*l) * kronecker_delta(a, b, 3);
}

double sh_ldots2(double s1, double s2, double s, double l, double s1p, double s2p, double sp, double lp, double j)
{
    double a[] = {s1, s2, l};
    double b[] = {s1p, s2p, lp};

    return pow(-1, s+lp+j) * sixJ_symbol(sp, s, 1, l, lp, j) * pow(-1, s1+s2+sp+1) * sqrt((2*sp+1)*(2*s+1)) * sixJ_symbol(s2, s2p, 1, sp, s, s1p) 
        * sqrt((2*s2+1)*(s2+1)*s2) * sqrt((2*l+1)*(l+1)*l) * kronecker_delta(a, b, 3);
}

double sh_tensor(double s1, double s2, double s, double l, double s1p, double s2p, double sp, double lp, double j)
{
    double a[] = {s1, s2};
    double b[] = {s1p, s2p};

    return pow(-1, s+lp+j) * sqrt(4.8*M_PI) * sixJ_symbol(sp, s, 2, l, lp, j) * sqrt(5*(2*sp+1)*(2*s+1)) * nineJ_symbol(s1p, s1, 1, s2p, s2, 1, sp, s, 2) 
        * sqrt((2*s1+1)*(s1+1)*s1) * sqrt((2*s2+1)*(s2+1)*s2) * pow(-1, lp) * sqrt(1.25*M_1_PI*(2*lp+1)*(2*l+1)) * threeJ_symbol(lp, 0, 2, 0, l, 0) * kronecker_delta(a, b, 2);
}